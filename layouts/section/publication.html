{{- define "main" -}}

{{/* Require Isotope */}}
{{ $.Page.Store.Set "has_isotope" true }}

{{ partial "page_header.html" . }}

<div class="universal-wrapper">
  <div class="row">
    <div class="col-lg-12">

      {{ with .Content }}
      <div class="article-style">{{ . }}</div>
      {{ end }}

      {{/* Array of distinct years. */}}
      {{ range .Pages.ByDate.Reverse }}
        {{ $year := print (.Date.Format "2006") }}
        {{ $.Scratch.SetInMap "years" $year $year }}
      {{ end }}

<!--      <div class="form-row mb-4">-->
<!--        <div class="col-auto">-->
<!--          <input type="search" class="filter-search form-control form-control-sm" placeholder="{{ i18n "search_placeholder" }}" autocapitalize="off"-->
<!--          autocomplete="off" autocorrect="off" role="textbox" spellcheck="false">-->
<!--        </div>-->
<!--        <div class="col-auto">-->
<!--          <select class="pub-filters pubtype-select form-control form-control-sm" data-filter-group="pubtype">-->
<!--            <option value="*">{{ i18n "publication_type" }}</option>-->
<!--            {{ range $index, $taxonomy := site.Taxonomies.publication_types }}-->
<!--            <option value=".pubtype-{{ $index }}">-->
<!--              {{ i18n (printf "pub_%s" (strings.Replace $index "-" "_")) | default (strings.Title $index) }}-->
<!--            </option>-->
<!--            {{ end }}-->
<!--          </select>-->
<!--        </div>-->
<!--        <div class="col-auto">-->
<!--          <select class="pub-filters form-control form-control-sm" data-filter-group="year">-->
<!--            <option value="*">{{ i18n "date" }}</option>-->
<!--            {{ $years_sorted := $.Scratch.GetSortedMapValues "years" }}-->
<!--            {{ if $years_sorted }}-->
<!--            {{ range $year := sort $years_sorted "" "desc" }}-->
<!--            <option value=".year-{{ $year }}">-->
<!--              {{ $year }}-->
<!--            </option>-->
<!--            {{ end }}-->
<!--            {{ end }}-->
<!--          </select>-->
<!--        </div>-->
<!--      </div>-->

      <div id="container-publications">
        {{ range $index, $item := .Pages.ByDate.Reverse }}

        {{ if .Params.publication_types }}
          {{ $.Scratch.Set "pubtype" (index .Params.publication_types 0) }}
        {{ else }}
          {{ $.Scratch.Set "pubtype" 0 }}
        {{ end }}

        <div class="grid-sizer col-lg-12 isotope-item pubtype-{{ $.Scratch.Get "pubtype" }} year-{{ .Date.Format "2006" }}">
          {{/* 修改1: 添加容器并注入外部链接数据 */}}
          <div class="publication-item-container" data-external-url="{{ $item.Params.external_url }}">
            {{ partial "functions/render_view" (dict "page" $ "item" . "view" ($.Params.view | default "compact") "index" $index) }}
          </div>
        </div>

        {{ end }}
      </div>

    </div>
  </div>
</div>

{{/* 修改2: 添加精准的点击拦截脚本 */}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 使用事件委托，监听整个出版物容器的点击事件
    document.getElementById('container-publications').addEventListener('click', function(event) {
        // 1. 精准定位：只针对“论文标题链接”
        //    特征：它是 .pub-list-item 直接子级的 <a> 标签（作者链接在更深层）
        const titleLink = event.target.closest('.pub-list-item > a');

        // 2. 如果点击的是论文标题链接
        if (titleLink) {
            // 找到这个链接所在的最外层容器，它上面有我们设置的 data-external-url
            const container = titleLink.closest('.publication-item-container');

            // 3. 如果该论文设置了外部链接
            if (container && container.dataset.externalUrl) {
                // 阻止默认行为（跳转到内部页面）
                event.preventDefault();
                event.stopPropagation();
                // 跳转到外部链接
                window.open(container.dataset.externalUrl, '_blank', 'noopener,noreferrer');
                console.log('论文标题被点击，跳转到外部链接:', container.dataset.externalUrl);
                return; // 重要：处理完毕，直接返回
            }
            // 4. 如果该论文没有设置外部链接，则什么也不做，放行点击（进入内部文章页）
        }
        // 5. 如果点击的不是论文标题链接（作者、PDF、Code等），则完全放行
    });
});
</script>

{{- end -}}
